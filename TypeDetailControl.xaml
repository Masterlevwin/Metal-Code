<UserControl xmlns:hc="https://handyorg.github.io/handycontrol"  x:Class="Metal_Code.TypeDetailControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Metal_Code"
             mc:Ignorable="d" 
             VerticalAlignment="Top" Padding="4">
    <UserControl.Resources>
        <local:MassConverter x:Key="MassConverter"/>
        <local:DestinyConverter x:Key="DestinyConverter"/>
        <local:CostConverter x:Key="CostConverter"/>
        <local:StockMaterialBackgroundConverter x:Key="StockMaterialBackgroundConverter"/>
        
        <!-- Плавные функции для анимации -->
        <PowerEase x:Key="EaseOut" EasingMode="EaseOut"/>
        <PowerEase x:Key="EaseIn" EasingMode="EaseIn"/>

        <!-- Анимация раскрытия PartsControl -->
        <Storyboard x:Key="ExpandParts">
            <DoubleAnimation Storyboard.TargetName="PartsStack"
                             Storyboard.TargetProperty="MaxHeight"
                             To="400"
                             Duration="0:0:0.35">
                <DoubleAnimation.EasingFunction>
                    <StaticResource ResourceKey="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="PartsStack"
                                           Storyboard.TargetProperty="Visibility">
                <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Visible}"/>
            </ObjectAnimationUsingKeyFrames>
        </Storyboard>

        <!-- Анимация сворачивания PartsControl -->
        <Storyboard x:Key="CollapseParts">
            <DoubleAnimation Storyboard.TargetName="PartsStack"
                             Storyboard.TargetProperty="MaxHeight"
                             To="0"
                             Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <StaticResource ResourceKey="EaseIn"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="PartsStack"
                                           Storyboard.TargetProperty="Visibility">
                <DiscreteObjectKeyFrame KeyTime="0:0:0.3" Value="{x:Static Visibility.Collapsed}"/>
            </ObjectAnimationUsingKeyFrames>
        </Storyboard>

        <!-- Цвета -->
        <SolidColorBrush x:Key="ButtonBackground" Color="#FFFFFFE1"/>
        <SolidColorBrush x:Key="BorderColor" Color="#D1D9E0"/>
        <SolidColorBrush x:Key="FocusBorderColor" Color="#4A90E2"/>

        <!-- Общая толщина границы -->
        <Thickness x:Key="DefaultBorderThickness">1</Thickness>

        <!-- Стиль для ToggleButton -->
        <Style x:Key="ExpandToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="{StaticResource ButtonBackground}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColor}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="{TemplateBinding BorderThickness}"
                        CornerRadius="4"
                        Padding="{TemplateBinding Padding}">
                            <StackPanel Orientation="Horizontal" 
                                HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                VerticalAlignment="{TemplateBinding VerticalContentAlignment}">
                                <!-- Основной текст из Content -->
                                <ContentPresenter x:Name="ContentPresenter"
                                          ContentSource="Content"
                                          RecognizesAccessKey="True"
                                          VerticalAlignment="Center"/>
                                <!-- Стрелка-индикатор состояния -->
                                <TextBlock x:Name="Arrow"
                                   Text="▼"
                                   Margin="6,0,0,0"
                                   VerticalAlignment="Center"
                                   Foreground="{TemplateBinding Foreground}"/>
                            </StackPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Arrow" Property="Text" Value="▲"/>
                                <!-- Опционально: подсветка при раскрытом состоянии -->
                                <Setter Property="Background" Value="#F0F8FF"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="BorderBrush" Value="{StaticResource FocusBorderColor}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </UserControl.Resources>

    <GroupBox x:Name="TypeDetailBox" BorderBrush="Gray">
        <GroupBox.Background>
            <MultiBinding Converter="{StaticResource StockMaterialBackgroundConverter}">
                <Binding Path="SelectedItem.Name" ElementName="TypeDetailDrop"/>
                <Binding Path="SelectedItem.Name" ElementName="MetalDrop"/>
            </MultiBinding>
        </GroupBox.Background>
        
        <GroupBox.Header>
            <StackPanel Orientation="Horizontal" Margin="5">
                <hc:ComboBox hc:InfoElement.Placeholder="Выбор заготовки" x:Name="TypeDetailDrop" DisplayMemberPath="Name" SelectedIndex="0" ToolTip="Выберите заготовку" SelectionChanged="CreateSort" Width="150"/>
                <hc:ComboBox hc:InfoElement.Placeholder="Тип" x:Name="SortDrop" ToolTip="Выберите вид детали" SelectionChanged="ChangeSort" Margin="10,0,0,0" Width="80"/>
                <TextBlock Text="A" VerticalAlignment="Top" FontSize="10" Margin="7,0,0,0" MinWidth="8"/>
                <TextBox x:Name="A_prop" Text="{Binding A, RelativeSource={RelativeSource AncestorType={x:Type local:TypeDetailControl}, Mode=FindAncestor}}" MaxLines="1" ToolTip="Высота, мм" TextChanged="SetProperty" Margin="3,0,0,0" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Width="40"/>
                <TextBlock Text="B" VerticalAlignment="Top" FontSize="10" Margin="7,0,0,0" MinWidth="8"/>
                <TextBox x:Name="B_prop" Text="{Binding B, RelativeSource={RelativeSource AncestorType={x:Type local:TypeDetailControl}, Mode=FindAncestor}}" MaxLines="1" ToolTip="Ширина, мм" TextChanged="SetProperty" Margin="3,0,0,0" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Width="40"/>
                <TextBlock Text="S" VerticalAlignment="Top" FontSize="10" Margin="7,0,0,0" MinWidth="8"/>
                <TextBox x:Name="S_prop" Foreground="{Binding S, Converter={StaticResource DestinyConverter}}" Text="{Binding S, RelativeSource={RelativeSource AncestorType={x:Type local:TypeDetailControl}, Mode=FindAncestor}}" MaxLines="1" ToolTip="Толщина, мм" TextChanged="SetProperty" MaxLength="3" Margin="3,0,0,0" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" FontWeight="Bold" Width="35"/>
                <TextBlock Text="L" VerticalAlignment="Top" FontSize="10" Margin="7,0,0,0" MinWidth="8"/>
                <TextBox x:Name="L_prop" Text="{Binding L, RelativeSource={RelativeSource AncestorType={x:Type local:TypeDetailControl}, Mode=FindAncestor}}" MaxLines="1" ToolTip="Длина, мм" TextChanged="SetProperty" MaxLength="5" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Margin="3,0,0,0" Width="40"/>
                <TextBlock Text="N" VerticalAlignment="Top" FontSize="10" Margin="7,0,0,0" MinWidth="8"/>
                <TextBox Text="{Binding Count, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type local:TypeDetailControl}}}" ToolTip="Введите количество заготовок" TextChanged="SetCount" MaxLength="4" MaxLines="1" Margin="3,0,0,0" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Width="40"/>
                <TextBlock Text="Вес" VerticalAlignment="Top" FontSize="10" Margin="7,0,0,0" MinWidth="16"/>
                <TextBlock Text="{Binding Mass, Converter={StaticResource MassConverter}}" Margin="3,0,0,0" TextAlignment="Center" VerticalAlignment="Center" Foreground="Blue" Width="40"/>
                <hc:ComboBox hc:InfoElement.Placeholder="Материал" x:Name="MetalDrop" DisplayMemberPath="Name" SelectedIndex="0" ToolTip="Выберите материал" SelectionChanged="MassCalculate" Margin="5,0,0,0" Width="120"/>
                <CheckBox x:Name="CheckMetal" IsChecked="{Binding HasMetal, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type local:TypeDetailControl}}}" Click="HasMetalChanged" ToolTip="Если не отмечено, материал - давальческий" Margin="5,0,0,0" HorizontalContentAlignment="Center" VerticalContentAlignment="Center"/>
                <TextBox x:Name="ResultText" Text="{Binding Result, Converter={StaticResource CostConverter}}" MouseDoubleClick="ResultTextEnabled" IsReadOnly="True" ToolTipOpening="SetToolTipForResult" ToolTip="Стоимость материала, руб" Margin="10,0,0,0" LostFocus="SetExtraResult" VerticalContentAlignment="Center" HorizontalContentAlignment="Right" BorderThickness="0" Background="{DynamicResource {x:Static SystemColors.ControlLightLightBrushKey}}" Foreground="Blue" Width="65"/>
                <Button Content="Х" local:DeleteHighlight.TargetElement="{Binding ElementName=TypeDetailBox}" FontWeight="Bold" Padding="0" MinWidth="20" MinHeight="20" MaxWidth="20" MaxHeight="20" FontSize="16" BorderThickness="0" Click="Remove" ToolTip="Удалить заготовку" Margin="5,0,0,0"/>
            </StackPanel>
        </GroupBox.Header>

        <StackPanel>
            <!-- Комментарий и кнопки -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,10,0">
                <Expander x:Name="CommentExpander" ExpandDirection="Left">
                    <StackPanel>
                        <TextBox Text="{Binding Comment}" TextChanged="SetComment" MinLines="2" Margin="0,0,5,0" TextWrapping="Wrap" Width="200"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,5,0">
                            <Button Content="азот" Margin="2" Padding="2" FontSize="10" Click="AddInfoToComment"/>
                            <Button Content="кром" Margin="2" Padding="2" FontSize="10" Click="AddInfoToComment"/>
                            <Button Content="шлиф" Margin="2" Padding="2" FontSize="10" Click="AddInfoToComment"/>
                            <Button Content="плен" Margin="2" Padding="2" FontSize="10" Click="AddInfoToComment"/>
                        </StackPanel>
                    </StackPanel>
                </Expander>

                <StackPanel hc:PanelElement.FluidMoveBehavior="{StaticResource BehaviorXY200}" x:Name="WorksStack" Margin="10,0,0,0">
                    <Button Click="AddWork" HorizontalAlignment="Left" Margin="5,5,0,0">
                        <StackPanel Orientation="Horizontal">
                            <Image Source="Images/plus.png" Width="12"/>
                            <TextBlock Text="Добавить работу" VerticalAlignment="Center" Margin="3,0,0,0" Padding="2"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </StackPanel>

            <!-- Кнопка для сворачивания/разворачивания PartsControl -->
            <ToggleButton x:Name="PartsToggle"
                          Style="{StaticResource ExpandToggleButtonStyle}"
                          Focusable="True"
                          Content="Список нарезанных деталей"
                          Click="OnPartsToggleClick"
                          ToolTip="Показать/скрыть список"
                          HorizontalAlignment="Right"
                          Margin="5,10,0,5">
            </ToggleButton>

            <!-- Контейнер для PartsControl -->
            <StackPanel x:Name="PartsStack"
                        MaxHeight="0"
                        Visibility="Collapsed"
                        Margin="0,0,0,10"
                        Cursor="" HorizontalAlignment="Left"/>
        </StackPanel>
    </GroupBox>
</UserControl>